<!DOCTYPE html>
<html>
<head>
  <title>Spelling Test</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      text-align: center;
    }
    #result.correct {
      font-size: 20px;
      color: green;
    }
    #result.incorrect {
      color: red;
      font-weight: bold;
    }
  </style>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getDatabase, ref, get, update, child } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';
    import firebaseConfig from './firebaseConfig.js';

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let currentWordIndex = 0;
    let words = [];

    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const groupNumber = urlParams.get('group');
      const wordListRef = ref(database, 'wordlist');
      const testResultsRef = ref(database, 'testResults');

      get(wordListRef).then(snapshot => {
        const allWords = snapshot.val() || [];
        const groupWords = allWords.slice((groupNumber - 1) * 100, groupNumber * 100);

        Promise.all(groupWords.map(word => {
          return get(child(testResultsRef, word)).then(resultSnapshot => {
            const resultData = resultSnapshot.val() || { correctCount: 0, incorrectCount: 0, totalTests: 0 };
            return { word, ...resultData };
          });
        })).then(wordData => {
          words = wordData.sort((a, b) => a.totalTests - b.totalTests || b.incorrectCount - a.incorrectCount || a.index - b.index);
          displayWord();
        });
      }).catch(error => {
        console.error("Error getting data: ", error);
      });
    });

    window.displayWord = function() {
      if (words.length === 0) return;
      const word = words[currentWordIndex].word;
      const utterance = new SpeechSynthesisUtterance(word);
      utterance.lang = 'en-US';
      speechSynthesis.speak(utterance);
      document.getElementById('wordNumber').innerText = `Word ${currentWordIndex + 1} of ${words.length}`;
      document.getElementById('spellingInput').value = '';
      document.getElementById('spellingInput').focus();
      document.getElementById('result').innerText = '';
      document.getElementById('playWordButton').innerText = 'Play Word';
    };

    window.checkSpelling = function() {
      const input = document.getElementById('spellingInput').value.trim();
      const word = words[currentWordIndex].word;
      const resultElement = document.getElementById('result');
      const playWordButton = document.getElementById('playWordButton');
      const now = new Date().toISOString();

      if (input === word) {
        resultElement.innerText = '正确';
        resultElement.className = 'correct';
        playWordButton.innerText = '下一个';
        saveTestResult(word, true, now);
        currentWordIndex++;
        if (currentWordIndex < words.length) {
          setTimeout(displayWord, 500);
        } else {
          resultElement.innerText = '测试完成！';
          playWordButton.disabled = true;
        }
      } else {
        resultElement.innerHTML = `错误，正确拼写为 <strong>${word}</strong>`;
        resultElement.className = 'incorrect';
        playWordButton.innerText = '重新测试';
        saveTestResult(word, false, now);
      }
    };

    window.retryWord = function() {
      const word = words[currentWordIndex].word;
      const utterance = new SpeechSynthesisUtterance(word);
      utterance.lang = 'en-US';
      speechSynthesis.speak(utterance);
      document.getElementById('spellingInput').value = '';
      document.getElementById('spellingInput').focus();
      document.getElementById('result').innerText = '';
      document.getElementById('playWordButton').innerText = 'Check';
    };

    window.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        const playWordButton = document.getElementById('playWordButton');
        if (playWordButton.innerText === '下一个') {
          displayWord();
        } else if (playWordButton.innerText === '重新测试') {
          retryWord();
        } else {
          checkSpelling();
        }
      }
    });

    window.saveTestResult = function(word, correct, timestamp) {
      const wordRef = child(ref(database, 'testResults'), word);
      get(wordRef).then(snapshot => {
        const data = snapshot.val() || { correctCount: 0, incorrectCount: 0, totalTests: 0 };
        if (correct) {
          data.correctCount++;
        } else {
          data.incorrectCount++;
        }
        data.totalTests++;
        data.lastTested = timestamp;
        update(wordRef, data);
      }).catch(error => {
        console.error("Error updating test result: ", error);
      });
    };
  </script>
</head>
<body>
  <h1>Spelling Test</h1>
  <p id="wordNumber"></p>
  <button id="playWordButton" onclick="displayWord()">Play Word</button>
  <input type="text" id="spellingInput">
  <p id="result"></p>
</body>
</html>
