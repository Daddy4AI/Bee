<!DOCTYPE html>
<html>
<head>
    <title>单词测试页</title>
</head>
<body>
    <h1>单词拼写测试</h1>
    <div id="test-area">
        <h2 id="word-sound"></h2>
        <button onclick="playSound()">播放声音</button>
        <input type="text" id="inputWord" placeholder="输入单词拼写" onkeypress="checkSpelling(event)">
        <button id="nextButton" onclick="nextWord()" style="display:none;">下一个</button>
    </div>
    <script>
        const db = firebase.firestore();
        let words = [];
        let currentIndex = 0;

        function loadWords() {
            const groupIndex = localStorage.getItem('currentGroup');
            const historyTitle = localStorage.getItem('currentHistory');
            if (groupIndex !== null) {
                db.collection('words').get().then(snapshot => {
                    const allWords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    words = allWords.slice(groupIndex * 150, (groupIndex + 1) * 150);
                    words.sort((a, b) => a.tested - b.tested || b.errors - a.errors);
                    startTest();
                });
            } else if (historyTitle !== null) {
                db.collection('words').get().then(snapshot => {
                    const allWords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (historyTitle === '从未测试单词') {
                        words = allWords.filter(word => word.tested === 0);
                    } else if (historyTitle === '测试单词错误次数超过1次') {
                        words = allWords.filter(word => word.errors > 1);
                    } else if (historyTitle === '测试单词错误次数超过3次') {
                        words = allWords.filter(word => word.errors > 3);
                    }
                    startTest();
                });
            }
        }

        function startTest() {
            if (words.length > 0) {
                displayWord();
            } else {
                alert('没有符合条件的单词');
            }
        }

        function displayWord() {
            const word = words[currentIndex];
            const utterance = new SpeechSynthesisUtterance(word.word);
            utterance.lang = 'en-US';
            speechSynthesis.speak(utterance);
            document.getElementById('word-sound').innerText = word.word;
        }

        function playSound() {
            const word = words[currentIndex];
            const utterance = new SpeechSynthesisUtterance(word.word);
            utterance.lang = 'en-US';
            speechSynthesis.speak(utterance);
        }

        function checkSpelling(event) {
            if (event.key === 'Enter') {
                const inputWord = document.getElementById('inputWord').value;
                const word = words[currentIndex];
                if (inputWord.trim().toLowerCase() === word.word.toLowerCase()) {
                    alert('正确');
                } else {
                    alert(`错误，正确拼写是: ${word.word}`);
                    word.errors++;
                }
                word.tested++;
                word.lastTested = new Date();
                db.collection('words').doc(word.id).update(word).then(() => {
                    document.getElementById('nextButton').style.display = 'block';
                });
            }
        }

        function nextWord() {
            currentIndex++;
            if (currentIndex < words.length) {
                document.getElementById('inputWord').value = '';
                document.getElementById('nextButton').style.display = 'none';
                displayWord();
            } else {
                alert('测试结束');
                window.location.href = 'wordselect.html';
            }
        }

        loadWords();
    </script>
    <!-- Firebase 配置 -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
</body>
</html>
